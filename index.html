<canvas id="gc" width="400" height="400"></canvas>

<script>
    //classes and global functions and variables
    var entitiesArray, keys;

    function drawGame() {
        for (e of entitiesArray) {
            e.display();
        }
    }

    function moveEntities() {
        for (e of entitiesArray) {
            e.move();
        }
    }

    class Entity {
        constructor(src, x, y, w, h) {
            this.image = new Image();
            this.image.src = src;
            this.x = x;
            this.y = y;
            this.xSpeed = 0;
            this.ySpeed = 0;
            this.width = w;
            this.height = h;
            //entitiesArray.push(this);
        }

        display() {
            ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
        }

        move() {
            this.x += this.xSpeed;
            this.y += this.ySpeed;
        }
    }

    class Helicopter extends Entity {
        constructor(src, x, y, w, h) {
            super(src, x, y, w, h);
            this.xSpeed = 1;
        }
    }

    class Trooper extends Entity {
        constructor(src, x, y, w, h) {
            super(src, x, y, w, h);
            this.ySpeed = 1.5;
        }

        move() {
            this.y += this.ySpeed;
            if (this.y > 355) {
                this.ySpeed = 0;
            }
        }
    }

    class Bullet extends Entity {
        constructor(src, x, y, xVec, yVec, rotation) {
            super(src, x, y, 10, 10);
            this.xSpeed = xVec * 2.5;
			this.ySpeed = yVec * 2.5;
			this.rotation = rotation;
		}
		
		display() {
			drawImageRot(this.image, this.x, this.y, this.width, this.height, this.rotation);
		}
    }

    class Turret extends Entity {
        constructor(src, x, y, w, h) {
            super(src, x, y, w, h);
            this.rotation = 0;
        }

        display() {
            drawImageRot(this.image, this.x, this.y, this.width, this.height, this.rotation);
        }

        rotate(x) {
            this.rotation += x;
        }
    }


    window.onload = function() {
        canv = document.getElementById("gc");
        ctx = canv.getContext("2d");
        entitiesArray = [];
        entitiesArray.push(new Turret('./turret.png', 165, 350, 50, 120));
        entitiesArray.push(new Helicopter('./helicopter_right.png', -75, 5, 75, 70));
        entitiesArray.push(new Trooper('./para.png', 10, 10, 40, 40));
        // document.addEventListener("keydown", keyPush);
        keys = [];
        bulletFlag = true; // todo: find a place or way to set this privately
        setInterval(game, 1000 / 200);
        setInterval(keyPress, 1000 / 50);
    }

    // game loop
    function game() {
        // clear screen
        ctx.fillStyle = "LightGrey";
        ctx.fillRect(0, 0, canv.width, canv.height);
        moveEntities();
        // draw in new positions
        drawGame();
    }

    function keyPress() {
        let turr = entitiesArray[0];
        if (keys[39]) {
            if (turr.rotation < 72) {
                turr.rotate(12);
            }
        }
        if (keys[37]) {
            if (turr.rotation > -72) {
                turr.rotate(-12);
            }
        }
        if (keys[32] && bulletFlag) {
            // X:= originX + cos(angle) * radius;
            // Y:= originY + sin(angle) * radius;
            var rad = -turr.rotation * Math.PI / 180 + Math.PI / 2;
            var xVec = Math.cos(rad);
            var yVec = -Math.sin(rad);
            var x = 186 + xVec * 44;
            var y = 404 + yVec * 44;

            entitiesArray.push(new Bullet('./bullet.png', x, y, xVec, yVec, turr.rotation));
            bulletFlag = false;
            setTimeout(function() {
                bulletFlag = true
            }, 100);
        }
    }

    onkeydown = onkeyup = function(e) {
        //run on every interaction of a key, sets the keys state to an array value
        keys[e.keyCode] = e.type === 'keydown';
    };

    // function keyPush(event) {
    //     switch (event.keyCode) {
    //         case 39:
    // 			entitiesArray[0].rotate(12);
    //             break;
    // 		case 37:
    // 			entitiesArray[0].rotate(-12);
    //             break;
    //         case 32:
    //             entitiesArray.push(new Bullet('./bullet.png', 186, 360, 10, 10));
    //             break;
    //     }
    // }

    // Credit: https://stackoverflow.com/a/11985464
    function drawImageRot(img, x, y, width, height, deg) {
        //Convert degrees to radian 
        var rad = deg * Math.PI / 180;

        //Set the origin to the center of the image
        ctx.translate(x + width / 2, y + height / 2);

        //Rotate the canvas around the origin
        ctx.rotate(rad);

        //draw the image    
        ctx.drawImage(img, width / 2 * (-1), height / 2 * (-1), width, height);

        //reset the canvas  
        ctx.rotate(rad * (-1));
        ctx.translate((x + width / 2) * (-1), (y + height / 2) * (-1));
    }

</script>
